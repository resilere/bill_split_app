{% extends "base.html" %}
{% block title %}Assign Bill Items{% endblock %}
{% block content %}
<h1 style="margin-bottom: 5px;">Review & Assign Items</h1>
<p style="margin-bottom: 20px; color: #555;">File uploaded: {{ filename }} | Estimated Total: €{{ "%.2f"|format(total_sum) }}</p>

<div style="display: flex; gap: 30px;">
    <div style="flex: 1; min-width: 300px;">
        <h2 style="margin-top: 0; border-bottom: none; padding-bottom: 0;">Original Receipt Snapshot</h2>
        {% if image_path %}
            <img src="{{ image_path }}" alt="Receipt Snapshot" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
        {% else %}
            <p>No image snapshot available.</p>
        {% endif %}
    </div>
    
    <div style="flex: 2;">
        <h2 style="margin-top: 0; border-bottom: none; padding-bottom: 0;">Assignment Form</h2>
        <form method="POST" action="{{ url_for('save_details') }}">
            <!-- Hidden fields for filename and bill date -->
            <input type="hidden" name="filename" value="{{ filename }}">
            <input type="hidden" name="bill_date" value="{{ bill_date }}">
            
            <!-- Payer Selection -->
            <div style="margin-bottom: 20px; padding: 15px; border: 1px solid #ddd; border-radius: 8px; background-color: #f9f9f9;">
                <label for="payer_id" style="font-weight: bold; display: block; margin-bottom: 10px; color: #1a73e8;">Who Paid the Bill?</label>
                <select name="payer_id" id="payer_id" required 
                        style="padding: 10px; border: 1px solid #ccc; border-radius: 4px; width: 100%;">
                    <option value="eser">Eser</option>
                    <option value="david">David</option>
                </select>
            </div>

            <!-- Manual Items Section -->
            <h3>Add Missing Items Manually</h3>
            <table id="manual-items-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="background-color: #e0e0e0;">
                        <th style="padding: 10px; text-align: left;">Description</th>
                        <th style="padding: 10px; text-align: right; width: 80px;">Price (€)</th>
                        <th style="padding: 10px; text-align: center; width: 250px;">Assign To</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="manual-items-body">
                    <!-- JS will add rows here -->
                </tbody>
            </table>
            <button type="button" onclick="addManualItem()" 
                    style="padding: 8px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; margin-bottom: 20px;">
                Add Item
            </button>

            <script>
            function addManualItem() {
                const tableBody = document.getElementById('manual-items-body');
                const index = tableBody.rows.length;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><input type="text" name="manual_description_${index}" placeholder="Item description" required style="width: 95%; border: 1px solid #ccc; border-radius: 4px; padding: 5px;"></td>
                    <td><input type="number" step="0.01" name="manual_price_${index}" placeholder="0.00" required style="width: 70px; text-align: right; border: 1px solid #ccc; border-radius: 4px; padding: 5px;"></td>
                    <td>
                        <select name="manual_assigned_to_${index}" required>
                            <option value="eser">Eser</option>
                            <option value="david">David</option>
                            <option value="shared" selected>Shared</option>
                        </select>
                    </td>
                    <td><button type="button" onclick="this.closest('tr').remove()" style="background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px;">Remove</button></td>
                `;
                tableBody.appendChild(row);
            }
            </script>

            <!-- Parsed Items Table -->
            <h3>Parsed Items</h3>
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background-color: #e0e0e0;">
                        <th style="padding: 10px; text-align: left;">Item Description</th>
                        <th style="padding: 10px; text-align: right; width: 80px;">Price (€)</th>
                        <th style="padding: 10px; text-align: center; width: 250px;">Assign To</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in parsed_items %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 10px;">
                            <input type="text" name="item_description_{{ loop.index0 }}" value="{{ item.description }}" readonly 
                                   style="width: 95%; border: none; background: transparent;">
                        </td>
                        <td style="padding: 10px; text-align: right;">
                            <input type="number" step="0.01" name="item_price_{{ loop.index0 }}" value="{{ '%.2f'|format(item.price) }}" required 
                                   style="width: 70px; text-align: right; border: 1px solid #ccc; border-radius: 4px; padding: 5px;">
                        </td>
                        <td style="padding: 10px; text-align: center;">
                            <div style="display: flex; justify-content: space-around; gap: 5px;">
                                <label><input type="radio" name="assigned_to_{{ loop.index0 }}" value="eser" > Eser</label>
                                <label><input type="radio" name="assigned_to_{{ loop.index0 }}" value="david"> David</label>
                                <label><input type="radio" name="assigned_to_{{ loop.index0 }}" value="shared" checked> Shared</label>
                                <label><input type="radio" name="assigned_to_{{ loop.index0 }}" value="excluded" style="color: #f44336;"> Exclude</label>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <button type="submit" style="margin-top: 30px; padding: 12px 25px; background-color: #4CAF50; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1.1em;">
                Save and Calculate Balances
            </button>
        </form>
    </div>
</div>

{% endblock %}
